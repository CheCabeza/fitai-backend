name: Daily Cron Job

on:
  schedule:
    # Run every day at 2:30 AM UTC
    - cron: '30 2 * * *'

jobs:
  daily-cron:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Run tests
      run: npm test
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    - name: Execute Daily AI Generation
      run: |
        echo "ğŸ”„ Starting daily AI generation..."
        
        # Create a simple script to run the AI functions
        cat > daily-generate.js << 'EOF'
        const { generateAndInsertExercise, generateAndInsertFood } = require('./dist/utils/ai.js');
        
        async function main() {
          try {
            console.log('ğŸ“ Generating daily exercise...');
            const exerciseResult = await generateAndInsertExercise();
            console.log('Exercise result:', exerciseResult);
            
            console.log('ğŸ“ Generating daily food...');
            const foodResult = await generateAndInsertFood();
            console.log('Food result:', foodResult);
            
            console.log('âœ… Daily generation completed');
          } catch (error) {
            console.error('Error:', error);
            process.exit(1);
          }
        }
        
        main();
        EOF
        
        # Execute the generation
        node daily-generate.js
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    - name: Show Results
      run: |
        echo "ğŸ“Š Daily generation results:"
        echo "Check your Supabase database for new exercises and foods"
      continue-on-error: true
